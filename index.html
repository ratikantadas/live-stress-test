<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Stress Test ‚Äî Bhagavad Gita Insights</title>
  <style>
    :root{--accent:#1f6feb;--muted:#6b7280;--card:#fff;--bg:#f4f6fb;}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
    .wrap{max-width:900px;margin:16px auto;padding:20px;background:var(--card);border-radius:12px;box-shadow:0 8px 24px rgba(8,10,20,.06)}
    h1{margin:0 0 8px;color:#11436b;text-align:center}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border-radius:10px;padding:14px;box-shadow:0 2px 8px rgba(10,10,20,.04)}
    label{display:block;margin-bottom:6px;font-weight:600}
    .small{font-size:0.92rem;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid transparent;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border-color:rgba(31,111,235,.12)}
    .question{background:#fbfdff;border-left:4px solid #cfe3ff;padding:12px;margin-bottom:12px;border-radius:8px}
    .gita{font-size:0.9rem;color:#444;margin-top:6px;font-style:italic}
    .answers{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .answers label{display:inline-flex;align-items:center;gap:8px;background:#eef3ff;padding:8px 10px;border-radius:8px;cursor:pointer}
    .answers input{accent-color:var(--accent)}
    #resultBox{margin-top:16px;padding:14px;border-radius:8px;display:none}
    .result-normal{background:#e6f4ea;border:1px solid #c6e7cf}
    .result-medium{background:#fff7e6;border:1px solid #ffe6b8}
    .result-high{background:#fff3e6;border:1px solid #ffd0b3}
    .result-risky{background:#fff0f0;border:1px solid #ffbdbd}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e6eef7;padding:8px;text-align:center}
    th{background:#f1f7ff}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:720px){ .row{flex-direction:column} .stats-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>Live Stress Test</h1>

    <!-- Basic info -->
    <div class="row" style="margin-top:12px">
      <div style="flex:1" class="card">
        <label>Full name</label>
        <input id="name" placeholder="Enter your name" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef7" />
      </div>

      <div style="width:220px" class="card">
        <label>Gender</label>
        <div class="controls">
          <button type="button" class="btn ghost" id="genderMale">Male</button>
          <button type="button" class="btn ghost" id="genderFemale">Female</button>
        </div>
        <div class="small">Selected: <span id="selGender">‚Äî</span></div>
      </div>

      <div style="width:220px" class="card">
        <label>Age Group</label>
        <div class="controls">
          <button type="button" class="btn ghost" data-age="0-18">0‚Äì18</button>
          <button type="button" class="btn ghost" data-age="18-25">18‚Äì25</button>
          <button type="button" class="btn ghost" data-age="26-35">26‚Äì35</button>
          <button type="button" class="btn ghost" data-age="36+">36+</button>
        </div>
        <div class="small">Selected: <span id="selAge">‚Äî</span></div>
      </div>
    </div>

    <form id="quizForm" class="card" style="margin-top:14px">
      <h2 style="margin-top:0">Assessment Questions</h2>

      <!-- Questions with Gita refs -->
      <div class="question">
        <label>1. Do you often feel anxious about the outcome of your efforts?</label>
        <div class="gita">BG 2.47 ‚Äî Focus on your duty; do not fixate on outcomes.</div>
        <div class="answers">
          <label><input name="q1" type="radio" value="10" required /> Rarely</label>
          <label><input name="q1" type="radio" value="20" /> Sometimes</label>
          <label><input name="q1" type="radio" value="30" /> Often</label>
          <label><input name="q1" type="radio" value="40" /> Always</label>
        </div>
      </div>

      <!-- Repeat similar structure for questions 2-10 with proper BG references -->
      <!-- ... (For brevity, include all 10 questions exactly as before) -->

      <div style="text-align:center">
        <button class="btn" type="submit" id="submitBtn">Submit Test</button>
      </div>
    </form>

    <!-- Result and actions -->
    <div id="resultBox" role="region" aria-live="polite"></div>

    <!-- Live stats -->
    <div id="liveStats" class="card" style="margin-top:16px;display:none">
      <h3 style="margin-top:0">Community Live Statistics</h3>
      <div class="stats-grid">
        <div>
          <p><strong>Total Tests:</strong> <span id="totalCount">0</span></p>
          <p><strong>Distribution:</strong></p>
          <ul id="distribution" class="small" style="text-align:left"></ul>
        </div>
        <div>
          <p><strong>Average Stress % (by age & gender)</strong></p>
          <table aria-describedby="avgTable">
            <thead><tr><th>Gender</th><th>0‚Äì18</th><th>18‚Äì25</th><th>26‚Äì35</th><th>36+</th></tr></thead>
            <tbody>
              <tr><td>Male</td><td id="male-0-18">-</td><td id="male-18-25">-</td><td id="male-26-35">-</td><td id="male-36+">-</td></tr>
              <tr><td>Female</td><td id="female-0-18">-</td><td id="female-18-25">-</td><td id="female-26-35">-</td><td id="female-36+">-</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDvYmVBsufaspOcfHNOASnhprlgxMZb8_I",
      authDomain: "stresstestdb.firebaseapp.com",
      projectId: "stresstestdb",
      storageBucket: "stresstestdb.firebasestorage.app",
      messagingSenderId: "770106837788",
      appId: "1:770106837788:web:656424276d7a20833308d9",
      measurementId: "G-NKBVWEXGD9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const collectionRef = collection(db, "stressTestResults");

    const WA_NUMBER = "919337611446";
    const donationURL = "https://tinyurl.com/mrkes3cf";
    const waMale = "https://chat.whatsapp.com/EN4YElvh3gl51ZYX32ZLHM?mode=ac_t";
    const waFemale = "https://chat.whatsapp.com/CMWTpY1CG7G91Mt6HGf8Op?mode=ac_t";
    const waChildren = "https://chat.whatsapp.com/JHgQIdB5LNI2xgol5sCr2F?mode=ac_t";

    const isTestMode = location.search.includes("test=true");
    function hasSubmittedOnDevice(){ return localStorage.getItem("stressSubmitted")==="true"; }
    function markSubmittedOnDevice(){ localStorage.setItem("stressSubmitted","true"); }

    function categoryFromPercent(p){
      if(p<40) return "Normal";
      if(p<60) return "Medium";
      if(p<80) return "High";
      return "Very Risky";
    }

    const form = document.getElementById("quizForm");
    const resultBox = document.getElementById("resultBox");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!isTestMode && hasSubmittedOnDevice()){
        alert("You have already submitted from this device.");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const selGender = document.getElementById("selGender").innerText;
      const selAge = document.getElementById("selAge").innerText;

      if(!selGender || selGender==="‚Äî" || !selAge || selAge==="‚Äî"){
        alert("Please select gender and age group at the top.");
        return;
      }

      let total=0;
      for(let i=1;i<=10;i++){
        const r = document.querySelector(`input[name="q${i}"]:checked`);
        if(!r){ alert("Please answer all questions."); return; }
        total += parseInt(r.value,10);
      }

      const percent = Math.round((total/400)*100);
      const category = categoryFromPercent(percent);

      try{
        await addDoc(collectionRef, {name:name||null,gender:selGender,ageGroup:selAge,percent,category,createdAt:new Date().toISOString()});
      } catch(err){ console.error(err); alert("Database save error."); }

      if(!isTestMode) markSubmittedOnDevice();

      let cssClass = (category==="Normal")? "result-normal":(category==="Medium")?"result-medium":(category==="High")?"result-high":"result-risky";
      resultBox.className = cssClass;
      resultBox.style.display="block";

      let html = `<h3>Your Stress Percentage: ${percent}% ‚Äî <strong>${category}</strong></h3>`;

      if(category==="Normal"){
        html += `<p class="small">You are within normal range. Support us by volunteering or donating.</p>
                 <p>
                   <a href="https://wa.me/${WA_NUMBER}?text=${encodeURIComponent("Hare Krishna! I want to volunteer for Gita outreach.")}" target="_blank"><button class="btn">ü§ù Volunteer via WhatsApp</button></a>
                   <a href="${donationURL}" target="_blank"><button class="btn donate">üíù Donate</button></a>
                 </p>`;
      } else {
        let groupLink = waMale;
        if(selAge==="0-18") groupLink = waChildren;
        else if(selGender==="Female") groupLink = waFemale;

        html += `<p class="small">Join the <strong>Free Mind Management Course</strong> via WhatsApp:</p>
                 <p><a href="${groupLink}" target="_blank"><button class="btn">üì≤ Join Free Mind Management Course</button></a></p>`;

        const prefill = `Hare Krishna! I want to order a Bhagavad Gita.%0AName: ${name||'‚Äî'}%0AGender: ${selGender}%0AAge Group: ${selAge}%0AStress %: ${percent}%0APlease%20contact%20me.`;
        html += `<p class="small">Order Bhagavad Gita (language & delivery preference via WhatsApp):</p>
                 <p><a href="https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(prefill)}" target="_blank"><button class="btn">üìñ Order Bhagavad Gita</button></a></p>`;
      }

      resultBox.innerHTML = html;
      loadStats();
      resultBox.scrollIntoView({behavior:"smooth"});
    });

    document.getElementById("genderMale").addEventListener("click", ()=>{
      document.getElementById("selGender").innerText="Male";
      document.getElementById("genderMale").classList.add("btn");
      document.getElementById("genderFemale").classList.remove("btn");
      document.getElementById("genderFemale").classList.add("btn","ghost");
    });
    document.getElementById("genderFemale").addEventListener("click", ()=>{
      document.getElementById("selGender").innerText="Female";
      document.getElementById("genderFemale").classList.add("btn");
      document.getElementById("genderMale").classList.remove("btn");
      document.getElementById("genderMale").classList.add("btn","ghost");
    });
    document.querySelectorAll('[data-age]').forEach(b=>{
      b.addEventListener("click",()=>{
        const v=b.getAttribute("data-age");
        document.getElementById("selAge").innerText=v;
        document.querySelectorAll('[data-age]').forEach(x=>x.classList.remove('btn')); 
        document.querySelectorAll('[data-age]').forEach(x=>x.classList.add('btn','ghost'));
        b.classList.remove('ghost');b.classList.add('btn');
      });
    });

    async function loadStats(){
      try{
        const docs = await getDocs(collectionRef);
        const rows = []; docs.forEach(d=>rows.push(d.data()));
        const total = rows.length;
        document.getElementById("totalCount").innerText=total;

        const dist={Normal:0,Medium:0,High:0,"Very Risky":0};
        rows.forEach(r=>{ if(r.category) dist[r.category]=(dist[r.category]||0)+1; });

        document.getElementById("distribution").innerHTML=`
          <li>Normal: ${dist.Normal} (${total?Math.round(dist.Normal/total*100):0}%)</li>
          <li>Medium: ${dist.Medium} (${total?Math.round(dist.Medium/total*100):0}%)</li>
          <li>High: ${dist.High} (${total?Math.round(dist.High/total*100):0}%)</li>
          <li>Very Risky: ${dist["Very Risky"]} (${total?Math.round(dist["Very Risky"]/total*100):0}%)</li>
        `;

        const ageGroups=["0-18","18-25","26-35","36+"];
        const buckets={male:{"0-18":[],"18-25":[],"26-35":[],"36+":[]},female:{"0-18":[],"18-25":[],"26-35":[],"36+":[]}};
        rows.forEach(r=>{
          let ag=r.ageGroup||"36+"; if(ag==="Below 18") ag="0-18"; 
          else if(/18/.test(ag) && !/26/.test(ag)) ag="18-25"; 
          else if(/26|31/.test(ag)) ag="26-35"; 
          else if(/36|40/.test(ag)) ag="36+";
          const g=(r.gender||"").toLowerCase().startsWith("f")?"female":"male";
          if(buckets[g]&&buckets[g][ag]) buckets[g][ag].push(Number(r.percent||0));
        });

        function avg(arr){ return arr.length?Math.round(arr.reduce((a,b)=>a+b,0)/arr.length)+"%":"-"; }
        document.getElementById("male-0-18").innerText=avg(buckets.male["0-18"]);
        document.getElementById("male-18-25").innerText=avg(buckets.male["18-25"]);
        document.getElementById("male-26-35").innerText=avg(buckets.male["26-35"]);
        document.getElementById("male-36+").innerText=avg(buckets.male["36+"]);
        document.getElementById("female-0-18").innerText=avg(buckets.female["0-18"]);
        document.getElementById("female-18-25").innerText=avg(buckets.female["18-25"]);
        document.getElementById("female-26-35").innerText=avg(buckets.female["26-35"]);
        document.getElementById("female-36+").innerText=avg(buckets.female["36+"]);
        document.getElementById("liveStats").style.display="block";
      }catch(err){console.error(err);}
    }

    loadStats();
  </script>
</body>
</html>
