<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Stress Test</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    .quiz { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
    .question { margin-bottom: 15px; }
    button { margin-top: 10px; padding: 10px 20px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; }
    button:hover { background: #0056b3; }
    .result { margin-top: 20px; padding: 15px; border-radius: 8px; background: #eef; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #007bff; color: white; }
  </style>
</head>
<body>
  <h1>Live Stress Test</h1>
  <div class="quiz">
    <div id="quizForm">
      <label>Gender:</label><br>
      <input type="radio" name="gender" value="Male" required> Male
      <input type="radio" name="gender" value="Female"> Female
      <br><br>
      <label>Age Group:</label><br>
      <input type="radio" name="age" value="0-18" required> 0-18
      <input type="radio" name="age" value="19-30"> 19-30
      <input type="radio" name="age" value="31-45"> 31-45
      <input type="radio" name="age" value="46-60"> 46-60
      <input type="radio" name="age" value="61+"> 61+
      <br><br>

      <!-- 10 Stress Questions -->
      <div class="question">1. I often feel overwhelmed.<br>
        <input type="radio" name="q1" value="10"> Strongly Agree
        <input type="radio" name="q1" value="7"> Agree
        <input type="radio" name="q1" value="4"> Neutral
        <input type="radio" name="q1" value="1"> Disagree
      </div>
      <div class="question">2. I sleep peacefully at night.<br>
        <input type="radio" name="q2" value="1"> Strongly Agree
        <input type="radio" name="q2" value="4"> Agree
        <input type="radio" name="q2" value="7"> Neutral
        <input type="radio" name="q2" value="10"> Disagree
      </div>
      <div class="question">3. I feel anxious without clear reason.<br>
        <input type="radio" name="q3" value="10"> Strongly Agree
        <input type="radio" name="q3" value="7"> Agree
        <input type="radio" name="q3" value="4"> Neutral
        <input type="radio" name="q3" value="1"> Disagree
      </div>
      <div class="question">4. I can focus on tasks easily.<br>
        <input type="radio" name="q4" value="1"> Strongly Agree
        <input type="radio" name="q4" value="4"> Agree
        <input type="radio" name="q4" value="7"> Neutral
        <input type="radio" name="q4" value="10"> Disagree
      </div>
      <div class="question">5. I get irritated quickly.<br>
        <input type="radio" name="q5" value="10"> Strongly Agree
        <input type="radio" name="q5" value="7"> Agree
        <input type="radio" name="q5" value="4"> Neutral
        <input type="radio" name="q5" value="1"> Disagree
      </div>
      <div class="question">6. I feel calm most of the time.<br>
        <input type="radio" name="q6" value="1"> Strongly Agree
        <input type="radio" name="q6" value="4"> Agree
        <input type="radio" name="q6" value="7"> Neutral
        <input type="radio" name="q6" value="10"> Disagree
      </div>
      <div class="question">7. I worry about the future.<br>
        <input type="radio" name="q7" value="10"> Strongly Agree
        <input type="radio" name="q7" value="7"> Agree
        <input type="radio" name="q7" value="4"> Neutral
        <input type="radio" name="q7" value="1"> Disagree
      </div>
      <div class="question">8. I enjoy my daily activities.<br>
        <input type="radio" name="q8" value="1"> Strongly Agree
        <input type="radio" name="q8" value="4"> Agree
        <input type="radio" name="q8" value="7"> Neutral
        <input type="radio" name="q8" value="10"> Disagree
      </div>
      <div class="question">9. I get headaches or tension often.<br>
        <input type="radio" name="q9" value="10"> Strongly Agree
        <input type="radio" name="q9" value="7"> Agree
        <input type="radio" name="q9" value="4"> Neutral
        <input type="radio" name="q9" value="1"> Disagree
      </div>
      <div class="question">10. I feel positive and hopeful.<br>
        <input type="radio" name="q10" value="1"> Strongly Agree
        <input type="radio" name="q10" value="4"> Agree
        <input type="radio" name="q10" value="7"> Neutral
        <input type="radio" name="q10" value="10"> Disagree
      </div>

      <button type="button" onclick="submitTest()">Submit</button>
    </div>

    <div id="result" class="result" style="display:none;"></div>
    <div id="stats" style="display:none;"></div>
  </div>

  <script>
    // Firebase init with your config
    const firebaseConfig = {
      apiKey: "AIzaSyDvYmVBsufaspOcfHNOASnhprlgxMZb8_I",
      authDomain: "stresstestdb.firebaseapp.com",
      projectId: "stresstestdb",
      storageBucket: "stresstestdb.firebasestorage.app",
      messagingSenderId: "770106837788",
      appId: "1:770106837788:web:656424276d7a20833308d9",
      measurementId: "G-NKBVWEXGD9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function submitTest(){
      let gender = document.querySelector('input[name="gender"]:checked');
      let age = document.querySelector('input[name="age"]:checked');
      if(!gender || !age){ alert("Please select gender and age group!"); return; }

      let score = 0;
      for(let i=1;i<=10;i++){
        let ans = document.querySelector('input[name="q'+i+'"]:checked');
        if(!ans){ alert("Please answer all questions!"); return; }
        score += parseInt(ans.value);
      }
      let percent = Math.round((score/100)*100);

      let status = "";
      if(percent < 40) status="Normal";
      else if(percent < 60) status="Medium";
      else if(percent < 80) status="High";
      else status="Very Risky";

      // Save in Firestore
      await db.collection("stressResults").add({
        gender: gender.value,
        age: age.value,
        score: percent,
        time: new Date()
      });

      // Show result + actions
      let msg = `<h3>Your Stress Percentage: ${percent}% (${status})</h3>`;
      if(status==="Normal"){
        msg += `<p>You seem fine! Support us by 
        <a href="https://tinyurl.com/mrkes3cf" target="_blank">Donating</a> 
        or <a href="https://wa.me/919337611446" target="_blank">Being a Volunteer</a>.</p>`;
      } else {
        // WhatsApp group links
        let waLink = "";
        if(age.value==="0-18") waLink="https://chat.whatsapp.com/JHgQIdB5LNI2xgol5sCr2F";
        else if(gender.value==="Male") waLink="https://chat.whatsapp.com/EN4YElvh3gl51ZYX32ZLHM";
        else waLink="https://chat.whatsapp.com/CMWTpY1CG7G91Mt6HGf8Op";

        msg += `<p>We recommend you join our <b>Free Mind Management Course</b>.<br>
        ðŸ‘‰ <a href="${waLink}" target="_blank">Join WhatsApp Group</a></p>
        <p>If you want to order a Bhagavad Gita, click below:<br>
        <a href="https://wa.me/919337611446?text=I%20want%20a%20Gita%20for%20stress%20management.%20Gender:%20${gender.value},%20Age:%20${age.value},%20Stress:%20${percent}%" target="_blank">Order Gita via WhatsApp</a></p>`;
      }
      document.getElementById("result").innerHTML=msg;
      document.getElementById("result").style.display="block";

      loadStats();
    }

    async function loadStats(){
      const snap = await db.collection("stressResults").get();
      let results = snap.docs.map(d=>d.data());
      document.getElementById("stats").style.display="block";

      let total = results.length;
      let groups = ["0-18","19-30","31-45","46-60","61+"];
      let males = {}, females = {};
      groups.forEach(g=>{males[g]=[]; females[g]=[];});

      results.forEach(r=>{
        if(r.gender==="Male") males[r.age].push(r.score);
        else females[r.age].push(r.score);
      });

      function avg(arr){ return arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1):"-"; }

      let table = `<h3>ðŸ“Š Statistics (Total Tests: ${total})</h3>
      <table><tr><th>Age Group</th><th>Male Avg %</th><th>Female Avg %</th></tr>`;
      groups.forEach(g=>{
        table += `<tr><td>${g}</td><td>${avg(males[g])}</td><td>${avg(females[g])}</td></tr>`;
      });
      table += "</table>";
      document.getElementById("stats").innerHTML=table;
    }
  </script>
</body>
</html>
